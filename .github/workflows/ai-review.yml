name: ğŸ¤– AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.java'

jobs:
  ai-review:
    runs-on: ubuntu-22.04
    container: ollama/ollama:latest

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: â¬‡ï¸ Pull AI Model
        run: ollama pull deepseek-coder:33b

      - name: ğŸ” Find Java Files
        id: java_files
        run: |
          echo "JAVA_FILES=$(find . -name '*.java' -type f | xargs realpath --relative-base=.)" >> $GITHUB_OUTPUT

      - name: ğŸ§  Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å®‰è£… jqï¼ˆç”¨äºå®‰å…¨å¤„ç† JSONï¼‰
          if ! command -v jq &> /dev/null; then
            apt-get update && apt-get install -y jq
          fi

          # éå†æ¯ä¸ª Java æ–‡ä»¶
          for file in ${{ steps.java_files.outputs.JAVA_FILES }}; do
            echo "ğŸ” æ­£åœ¨è¯„å®¡: $file"
            
            # è°ƒç”¨ AI åˆ†æä»£ç ï¼ˆEOF_PROMPT å¿…é¡»é¡¶æ ¼ï¼ï¼‰
            OUTPUT=$(ollama run deepseek-coder:33b << 'EOF_PROMPT')
è¯·ä¸¥æ ¼åˆ†æä»¥ä¸‹Javaä»£ç ï¼Œé‡ç‚¹å…³æ³¨ï¼š
1. çº¿ç¨‹å®‰å…¨ï¼ˆå¦‚ SimpleDateFormat ä½¿ç”¨ï¼‰
2. å¼‚å¸¸å¤„ç†ï¼ˆé¿å… throws Exceptionï¼‰
3. æ—¥å¿—è®°å½•ï¼ˆæ˜¯å¦ä½¿ç”¨ SLF4Jï¼‰
4. ç©ºå€¼æ£€æŸ¥
5. æ€§èƒ½é—®é¢˜

è¯·ä»¥æ ‡å‡†JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–è¯´æ˜ï¼š
{
  "file": "placeholder",
  "issues": [
    {
      "line": 1,
      "severity": "error",
      "message": "é—®é¢˜æè¿°",
      "suggestion": "æ”¹è¿›å»ºè®®"
    }
  ],
  "score": 85
}

ä»£ç å¦‚ä¸‹ï¼š
$(cat "$file")
EOF_PROMPT
            )

            # ä½¿ç”¨ jq å®‰å…¨æ›¿æ¢æ–‡ä»¶å
            echo "$OUTPUT" | jq --arg filepath "$file" '.file = $filepath' > ai-review-result.json

            # æ£€æŸ¥æ˜¯å¦æœ‰ error çº§é—®é¢˜
            if jq -e '.issues[] | select(.severity == "error")' ai-review-result.json > /dev/null; then
              echo "âŒ AI å‘ç°ä¸¥é‡é—®é¢˜ï¼Œé˜»æ–­æ„å»º"
              cat ai-review-result.json
              exit 1
            fi
            
            echo "âœ… $file é€šè¿‡ AI è¯„å®¡"
          done
