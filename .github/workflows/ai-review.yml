name: "ğŸ¤– AI Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/*.java'

jobs:
  ai-review:
    runs-on: ubuntu-22.04
    container:
      image: ollama/ollama:latest

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â¬‡ï¸ Pull AI Model
        run: |
          ollama pull deepseek-coder:33b

      - name: ğŸ” Find Changed Java Files
        id: java_files
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="${{ github.base_ref }}"
          if [ -n "$BASE_REF" ]; then
            git fetch --quiet origin "$BASE_REF" || true
            JAVA_FILES=$(git diff --name-only "origin/$BASE_REF" HEAD | grep '\.java$' || true)
          else
            JAVA_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.java$' || true)
          fi

          # å°†å¤šè¡Œå®‰å…¨å†™å…¥ GITHUB_OUTPUT
          {
            echo "JAVA_FILES<<EOF"
            echo "$JAVA_FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ§  Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # å®‰è£… jqï¼ˆå®¹å™¨å†…å¯èƒ½æ²¡æœ‰ï¼‰
          if ! command -v jq >/dev/null 2>&1; then
            apt-get update -y
            apt-get install -y jq
          fi

          FILES="${{ steps.java_files.outputs.JAVA_FILES }}"
          if [ -z "$FILES" ]; then
            echo "No Java files changed. Skipping AI review."
            exit 0
          fi

          IFS=$'\n'
          HAS_ERROR=0

          for file in $FILES; do
            echo "ğŸ” æ­£åœ¨è¯„å®¡: $file"

            cat > /tmp/ai-prompt.txt <<'PROMPT_EOF'
è¯·ä¸¥æ ¼åˆ†æä»¥ä¸‹Javaä»£ç ï¼Œé‡ç‚¹å…³æ³¨ï¼š
1. çº¿ç¨‹å®‰å…¨ï¼ˆå¦‚ SimpleDateFormat ä½¿ç”¨ï¼‰
2. å¼‚å¸¸å¤„ç†ï¼ˆé¿å… throws Exceptionï¼‰
3. æ—¥å¿—è®°å½•ï¼ˆæ˜¯å¦ä½¿ç”¨ SLF4Jï¼‰
4. ç©ºå€¼æ£€æŸ¥
5. æ€§èƒ½é—®é¢˜

è¯·ä»¥æ ‡å‡†JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰ä»»ä½•é¢å¤–è¯´æ˜ï¼š
{
  "file": "placeholder",
  "issues": [
    {
      "line": 1,
      "severity": "error",
      "message": "é—®é¢˜æè¿°",
      "suggestion": "æ”¹è¿›å»ºè®®"
    }
  ],
  "score": 85
}

ä»£ç å¦‚ä¸‹ï¼š
PROMPT_EOF

            # é™„åŠ ä»£ç åˆ°æç¤ºæ–‡ä»¶
            cat "$file" >> /tmp/ai-prompt.txt

            # è°ƒç”¨ AI åˆ†æï¼ˆå¤±è´¥æ—¶ä¿ç•™è¾“å‡ºç”¨äºè¯Šæ–­ï¼‰
            OUTPUT=$(ollama run deepseek-coder:33b < /tmp/ai-prompt.txt || true)

            # æå–ç¬¬ä¸€ä¸ª JSON å¯¹è±¡ï¼ˆå°½é‡ç¨³å¥ï¼‰
            OUTPUT_JSON=$(echo "$OUTPUT" | tr '\n' ' ' | sed -n 's/.*\({[^}]*}\).*/\1/p' || true)

            SAFE_NAME=$(echo "$file" | sed 's|/|_|g')
            RESULT_FILE="ai-review-result-${SAFE_NAME}.json"

            if [ -z "$OUTPUT_JSON" ]; then
              echo "âš ï¸ AI è¾“å‡ºä¸æ˜¯æœ‰æ•ˆ JSONï¼ˆæˆ–è¢«å¤šä½™æ–‡å­—æ±¡æŸ“ï¼‰: $file"
              echo "$OUTPUT" > "ai-review-raw-${SAFE_NAME}.txt"
              HAS_ERROR=1
            else
              echo "$OUTPUT_JSON" | jq --arg filepath "$file" '.file = $filepath' > "$RESULT_FILE"
              if jq -e '.issues[] | select(.severity == "error")' "$RESULT_FILE" >/dev/null 2>&1; then
                HAS_ERROR=1
              fi
            fi

            rm -f /tmp/ai-prompt.txt
          done

          if [ "$HAS_ERROR" -eq 1 ]; then
            echo "âŒ AI å‘ç°ä¸¥é‡é—®é¢˜æˆ–è¾“å‡ºå¼‚å¸¸ï¼Œé˜»æ–­æ„å»º"
            ls -1 ai-review-*.json ai-review-raw-*.txt || true
            exit 1
          fi

          echo "âœ… æ‰€æœ‰ Java æ–‡ä»¶é€šè¿‡ AI è¯„å®¡"
